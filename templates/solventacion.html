{% extends "base.html" %}
{% block title %}Solventaci√≥n de Caso{% endblock %}

{% block content %}
<div class="solventacion-container">
  <header class="header-flex">
    <h2>Solventaci√≥n de Posible Duplicidad</h2>
    <span class="subtitle">Actualiza el estado de la revisi√≥n</span>
  </header>

  <div class="info-rfc">
    <p><strong>RFC:</strong> {{ rfc }}</p>
    <p><strong>Nombre:</strong> {{ info.nombre or 'Sin nombre' }}</p>
    {% if request.args.get('ente') %}
    <p><strong>Ente:</strong> {{ request.args.get('ente') }}</p>
    {% endif %}
  </div>

  <form id="solventacionForm"
        method="post"
        action="{{ url_for('solventacion_detalle', rfc=rfc) }}"
        data-rfc="{{ rfc }}">

    <!-- Captura el ente pasado en la URL -->
    <input type="hidden" name="ente" value="{{ request.args.get('ente') or (info.entes[0] if info.entes else '') }}">

    <!-- Estado de valoraci√≥n -->
    <div class="form-group">
      <label for="estado">Estado de valoraci√≥n:</label>
      <select id="estado" name="estado" required>
        <option value="Sin valoraci√≥n" {% if estado_prev == 'Sin valoraci√≥n' or not estado_prev %}selected{% endif %} disabled>
          Sin valoraci√≥n
        </option>
        <option value="Solventado" {% if estado_prev == 'Solventado' %}selected{% endif %}>Solventado</option>
        <option value="No Solventado" {% if estado_prev == 'No Solventado' %}selected{% endif %}>No Solventado</option>
      </select>
    </div>

    <!-- Cat√°logo de Soluciones (visible solo si el estado es Solventado o No Solventado) -->
    <div class="form-group" id="catalogoContainer" style="display: none;">
      <label for="catalogo">Cat√°logo de Soluciones:</label>
      <select id="catalogo" name="catalogo" required>
        <option value="">Selecciona una soluci√≥n...</option>
        <option value="Ajuste de configuraci√≥n" {% if catalogo_prev == 'Ajuste de configuraci√≥n' %}selected{% endif %}>Ajuste de configuraci√≥n</option>
        <option value="Actualizaci√≥n de software" {% if catalogo_prev == 'Actualizaci√≥n de software' %}selected{% endif %}>Actualizaci√≥n de software</option>
        <option value="Reemplazo de hardware" {% if catalogo_prev == 'Reemplazo de hardware' %}selected{% endif %}>Reemplazo de hardware</option>
        <option value="Capacitaci√≥n al usuario" {% if catalogo_prev == 'Capacitaci√≥n al usuario' %}selected{% endif %}>Capacitaci√≥n al usuario</option>
        <option value="Revisi√≥n de documentaci√≥n" {% if catalogo_prev == 'Revisi√≥n de documentaci√≥n' %}selected{% endif %}>Revisi√≥n de documentaci√≥n</option>
        <option value="Otro" {% if catalogo_prev == 'Otro' %}selected{% endif %}>Otro</option>
      </select>
    </div>

    <!-- Campo Especifique Soluci√≥n (solo si el cat√°logo = Otro) -->
    <div class="form-group" id="otroContainer" style="display: none;">
      <label for="otro_texto">Especifique soluci√≥n:</label>
      <textarea id="otro_texto" name="otro_texto" rows="3"
        placeholder="Describa la soluci√≥n aplicada...">{{ otro_texto_prev or '' }}</textarea>
    </div>

    <!-- Botones -->
    <div class="btn-area">
      <button type="submit" class="btn btn-primary">üíæ Guardar cambios</button>
      <a href="{{ url_for('resultados_por_rfc', rfc=rfc) }}" class="btn btn-secondary">‚Üê Regresar</a>
    </div>

    <p id="confirmacion" class="confirmacion"></p>
  </form>
</div>

<!-- L√≥gica din√°mica -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const estadoSelect = document.getElementById("estado");
  const catalogoContainer = document.getElementById("catalogoContainer");
  const catalogoSelect = document.getElementById("catalogo");
  const otroContainer = document.getElementById("otroContainer");

  function actualizarVisibilidad() {
    const estado = estadoSelect.value;
    if (estado === "Solventado" || estado === "No Solventado") {
      catalogoContainer.style.display = "block";
    } else {
      catalogoContainer.style.display = "none";
      otroContainer.style.display = "none";
      catalogoSelect.value = "";
    }
  }

  function verificarOtro() {
    otroContainer.style.display = catalogoSelect.value === "Otro" ? "block" : "none";
  }

  estadoSelect.addEventListener("change", actualizarVisibilidad);
  catalogoSelect.addEventListener("change", verificarOtro);

  // Inicializar visibilidad correcta al cargar la p√°gina
  actualizarVisibilidad();
  verificarOtro();
});
</script>
{% endblock %}

