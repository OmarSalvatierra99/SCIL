<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCIL QNA 2025 - Dashboard | OFS Tlaxcala</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <img src="{{ url_for('static', filename='ofs_logo.png') }}" alt="OFS" style="height:40px;border-radius:6px;">
        <div>
          <h1>SCIL QNA 2025</h1>
          <span>√ìrgano de Fiscalizaci√≥n Superior del Estado de Tlaxcala</span>
        </div>
      </div>
      <div class="nav-links">
        <a href="{{ url_for('dashboard') }}" class="nav-link active">Inicio</a>
        <a href="{{ url_for('resultados_patrones') }}" class="nav-link">Laborales</a>
        <a href="{{ url_for('resultados_horarios') }}" class="nav-link">Horarios</a>
        <a href="{{ url_for('logout') }}" class="nav-link">Salir</a>
      </div>
    </div>
  </nav>

  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <h2>Panel de Auditor√≠a QNA</h2>
        <p>Analiza relaciones laborales por quincena y cruces de horarios docentes</p>
      </div>

      <!-- Secci√≥n de an√°lisis laboral -->
      <section class="upload-section">
        <h3 style="text-align:center;margin-bottom:1rem;">üîç An√°lisis de Patrones Laborales (por quincenas)</h3>
        <div class="upload-card">
          <div class="upload-area" id="uploadLaboral">
            <form id="formLaboral" enctype="multipart/form-data">
              <input type="file" id="fileLaboral" name="files" accept=".xlsx" class="file-input" multiple required>
              <div class="upload-content">
                <div class="upload-icon">üìÅ</div>
                <h3>Subir archivos Excel</h3>
                <p>Puedes seleccionar uno o varios archivos con estructura QNA1‚ÄìQNA12</p>
              </div>
              <div class="upload-progress" style="display:none;">
                <div class="progress-spinner"></div>
                <p>Procesando archivos...</p>
              </div>
            </form>
          </div>
        </div>
        <div id="resultLaboral" class="results-minimal" style="display:none;"></div>
      </section>

      <!-- Secci√≥n de an√°lisis de horarios -->
      <section class="upload-section" style="margin-top:3rem;">
        <h3 style="text-align:center;margin-bottom:1rem;">‚è∞ Cruce de Horarios Docentes</h3>
        <div class="upload-card">
          <div class="upload-area" id="uploadHorarios">
            <form id="formHorarios" enctype="multipart/form-data">
              <input type="file" id="fileHorarios" name="files" accept=".xlsx" class="file-input" multiple required>
              <div class="upload-content">
                <div class="upload-icon">üïì</div>
                <h3>Subir archivos Excel</h3>
                <p>Selecciona uno o varios archivos de horarios docentes</p>
              </div>
              <div class="upload-progress" style="display:none;">
                <div class="progress-spinner"></div>
                <p>Procesando archivos...</p>
              </div>
            </form>
          </div>
        </div>
        <div id="resultHorarios" class="results-minimal" style="display:none;"></div>
      </section>
    </div>
  </main>

  <script>
    function uploadHandler(formId, uploadUrl, resultDivId, redirectUrl) {
      const form = document.getElementById(formId);
      const input = form.querySelector("input[type=file]");
      const progress = form.parentElement.querySelector(".upload-progress");
      const content = form.parentElement.querySelector(".upload-content");
      const resultDiv = document.getElementById(resultDivId);

      form.parentElement.addEventListener("click", (e) => {
        if (e.target.tagName.toLowerCase() === "input") return;
        input.click();
      });

      input.addEventListener("change", () => {
        const files = input.files;
        if (!files.length) {
          alert("Debes seleccionar al menos un archivo Excel (.xlsx)");
          return;
        }

        progress.style.display = "block";
        content.style.display = "none";

        const formData = new FormData();
        for (let file of files) formData.append("files", file);

        fetch(uploadUrl, { method: "POST", body: formData })
          .then(res => res.json())
          .then(data => {
            progress.style.display = "none";
            content.style.display = "block";
            resultDiv.style.display = "block";
            if (data.error) {
              resultDiv.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
            } else {
              resultDiv.innerHTML = `
                <div class="result-minimal-card">
                  <h3>‚úÖ ${data.mensaje}</h3>
                  <div class="result-minimal-stats">
                    <span class="stat">${data.total_resultados || 0} resultados</span>
                    <span class="stat">${data.nuevos || 0} nuevos</span>
                  </div>
                  <a href="${redirectUrl}" class="btn btn-primary">Ver resultados</a>
                </div>`;
            }
          })
          .catch(err => {
            progress.style.display = "none";
            content.style.display = "block";
            resultDiv.innerHTML = `<div class="alert alert-error">Error: ${err}</div>`;
          });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      uploadHandler("formLaboral", "/upload", "resultLaboral", "/resultados");
      uploadHandler("formHorarios", "/upload_horarios", "resultHorarios", "/resultados_horarios");
    });
  </script>
</body>
</html>

