<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCIL - Dashboard | OFS Tlaxcala</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <img src="{{ url_for('static', filename='ofs_logo.png') }}" alt="OFS" style="height:40px;border-radius:6px;">
        <div>
          <h1>SCIL</h1>
          <span>√ìrgano de Fiscalizaci√≥n Superior del Estado de Tlaxcala</span>
        </div>
      </div>
      <div class="nav-links">
        <a href="{{ url_for('dashboard') }}" class="nav-link active">Inicio</a>
        <a href="{{ url_for('mostrar_resultados') }}" class="nav-link">Laborales</a>
        <a href="{{ url_for('mostrar_resultados_horarios') }}" class="nav-link">Horarios</a>
        <a href="{{ url_for('logout') }}" class="nav-link">Salir</a>
      </div>
    </div>
  </nav>

  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <h2>Panel de Auditor√≠a</h2>
        <p>Analice informaci√≥n laboral y cruces de horarios docentes</p>
      </div>

      <!-- Secci√≥n de an√°lisis laboral -->
      <section class="upload-section">
        <h3 style="text-align:center;margin-bottom:1rem;">üîç An√°lisis de Patrones Laborales</h3>
        <div class="upload-card">
          <div class="upload-area" id="uploadLaboral">
            <form id="formLaboral" enctype="multipart/form-data">
              <input type="file" id="fileLaboral" name="file" accept=".xlsx" class="file-input" required>
              <div class="upload-content">
                <div class="upload-icon">üìÅ</div>
                <h3>Subir archivo Excel</h3>
                <p>Analiza duplicidades laborales (ingreso / egreso)</p>
              </div>
              <div class="upload-progress" style="display:none;">
                <div class="progress-spinner"></div>
                <p>Procesando archivo...</p>
              </div>
            </form>
          </div>
        </div>
        <div id="resultLaboral" class="results-minimal" style="display:none;"></div>
      </section>

      <!-- Secci√≥n de an√°lisis de horarios -->
      <section class="upload-section" style="margin-top:3rem;">
        <h3 style="text-align:center;margin-bottom:1rem;">‚è∞ Cruce de Horarios Docentes</h3>
        <div class="upload-card">
          <div class="upload-area" id="uploadHorarios">
            <form id="formHorarios" enctype="multipart/form-data">
              <input type="file" id="fileHorarios" name="file" accept=".xlsx" class="file-input" required>
              <div class="upload-content">
                <div class="upload-icon">üïì</div>
                <h3>Subir archivo Excel</h3>
                <p>Detecta maestros con cruces de horario en diferentes planteles</p>
              </div>
              <div class="upload-progress" style="display:none;">
                <div class="progress-spinner"></div>
                <p>Procesando archivo...</p>
              </div>
            </form>
          </div>
        </div>
        <div id="resultHorarios" class="results-minimal" style="display:none;"></div>
      </section>
    </div>
  </main>

  <script>
    // Reutilizable para ambos formularios
    function uploadHandler(formId, uploadUrl, resultDivId) {
      const form = document.getElementById(formId);
      const input = form.querySelector("input[type=file]");
      const progress = form.parentElement.querySelector(".upload-progress");
      const content = form.parentElement.querySelector(".upload-content");
      const resultDiv = document.getElementById(resultDivId);

      form.parentElement.addEventListener("click", () => input.click());

      input.addEventListener("change", () => {
        const file = input.files[0];
        if (!file.name.endsWith(".xlsx")) {
          alert("Solo se permiten archivos Excel (.xlsx)");
          return;
        }

        progress.style.display = "block";
        content.style.display = "none";

        const formData = new FormData();
        formData.append("file", file);

        fetch(uploadUrl, { method: "POST", body: formData })
          .then(res => res.json())
          .then(data => {
            progress.style.display = "none";
            content.style.display = "block";
            resultDiv.style.display = "block";
            if (data.error) {
              resultDiv.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
            } else {
              resultDiv.innerHTML = `
                <div class="result-minimal-card">
                  <h3>‚úÖ ${data.mensaje}</h3>
                  <div class="result-minimal-stats">
                    <span class="stat">${data.total_resultados} resultados</span>
                    <span class="stat">${data.nuevos} nuevos</span>
                  </div>
                  <a href="${uploadUrl.includes('horarios') ? '/resultados_horarios' : '/resultados'}" class="btn btn-primary">
                    Ver resultados
                  </a>
                </div>`;
            }
          })
          .catch(err => {
            progress.style.display = "none";
            content.style.display = "block";
            resultDiv.innerHTML = `<div class="alert alert-error">Error: ${err}</div>`;
          });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      uploadHandler("formLaboral", "/upload", "resultLaboral");
      uploadHandler("formHorarios", "/upload_horarios", "resultHorarios");
    });
  </script>
</body>
</html>

